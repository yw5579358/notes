## âœ…æ··åˆæ£€ç´¢å®Œæ•´æµç¨‹è¯´æ˜ï¼ˆç»“æ„åŒ– + å‘é‡æ£€ç´¢ï¼‰

### ğŸ”¹ æ¥å£å…¥å£ï¼š`/filterList`

```java
@GetMapping("/filterList")
public R<PageResult<DocumentSearchResponse>> searchDocuments(DocumentSearchRequest request)
```

### âœ… ç¬¬ä¸€æ­¥ï¼šä¸»æœç´¢é€»è¾‘åˆ†å‘ï¼ˆvector or non-vectorï¼‰

```java
public PageResult<DocumentSearchResponse> searchDocuments(DocumentSearchRequest request)
```

#### ğŸ‘‡ å†…éƒ¨æ ¸å¿ƒåˆ†æ”¯é€»è¾‘ï¼š

| æ¡ä»¶                                | è¿›å…¥æœç´¢æ–¹æ³•        |
| ----------------------------------- | ------------------- |
| `keyword` ä¸ºç©º                      | `nonVectorSearch()` |
| `request.getStatus()` â‰  `COMPLETED` | `nonVectorSearch()` |
| å…¶ä½™æƒ…å†µï¼ˆæœ‰å…³é”®è¯ + å·²ä¸Šä¼ å‘é‡ï¼‰   | `vectorSearch()`    |

------

## âœ³ï¸ éå‘é‡æ£€ç´¢ï¼š`nonVectorSearch()`

```java
// ç›´æ¥ä» MyBatis + MySQL æŸ¥ç»“æ„åŒ–å­—æ®µï¼ˆæ ‡é¢˜ã€åˆ†ç±»ã€æ ‡ç­¾ã€å‘å¸ƒæ—¶é—´ï¼‰
page = documentMapper.searchDocuments(page, request);
addTagsInfo(page.getRecords());
```

- æ”¯æŒåˆ†é¡µ
- æ ‡ç­¾ä¿¡æ¯é€šè¿‡ `selectTagsByDocumentIds()` è¡¥å……
- å¸¸ç”¨äºç©ºå…³é”®è¯ / ä¸æ”¯æŒåµŒå…¥çš„æƒ…å†µ

------

## ğŸ” å‘é‡æ£€ç´¢ï¼š`vectorSearch()`

### æ ¸å¿ƒæµç¨‹ï¼š

1. æ£€æŸ¥ç´¢å¼•æœ‰æ•ˆæ€§ï¼ˆè‹¥çŸ¥è¯†åº“æœªå»ºç´¢å¼• â†’ fallbackï¼‰
2. æ„å»º filter æ¡ä»¶ï¼šå¦‚æ ‡ç­¾ã€æ—¶é—´èŒƒå›´ã€çŸ¥è¯†åº“ç´¢å¼•å
3. æ„é€ å‘é‡æŸ¥è¯¢è¯·æ±‚ï¼š
   - query: ç”¨æˆ· keyword
   - topK: é¡µå¤§å°
   - similarityThreshold: ç›¸ä¼¼åº¦é—¨é™
   - filter: ç»“æ„åŒ–æ¡ä»¶

```java
List<org.springframework.ai.document.Document> docs = vectorStore.similaritySearch(searchRequest);
```

1. å‘é‡å‘½ä¸­ä¸ºç©ºæ—¶ â†’ fallback åˆ°ç»“æ„åŒ–æ£€ç´¢
2. å‘½ä¸­æœ‰ç»“æœï¼š
   - æå–å‘é‡å‘½ä¸­çš„æ–‡æ¡£ ID
   - é€šè¿‡ ID åæŸ¥ MySQL â†’ å¾—åˆ°ç»“æ„åŒ–æ•°æ® + æ ‡ç­¾
   - è®¾ç½®æ€»æ•°ä¸ºå‘é‡å‘½ä¸­çš„æ•°é‡ï¼ˆç”¨äºåˆ†é¡µï¼‰

------

## ğŸ§© Filter æ¡ä»¶æ„å»ºï¼ˆç»“æ„åŒ– + å‘é‡å…±åŒä½¿ç”¨ï¼‰

```java
Filter.Expression expression = buildFilterExpression(request, knowledgeBase)
```

æ”¯æŒçš„ç»“æ„åŒ–æ¡ä»¶ï¼š

| å­—æ®µ         | æ¡ä»¶ç±»å‹  |
| ------------ | --------- |
| index_name   | eq        |
| id åˆ—è¡¨      | in        |
| tag_ids      | in        |
| publish_time | gte / lte |



æœ€ç»ˆé€šè¿‡ AND æ‹¼æ¥ä¸ºä¸€ä¸ª Filter.Expressionï¼Œç”¨äºï¼š

- å‘é‡æ£€ç´¢è¿‡æ»¤
- æŸ¥è¯¢ç»“æ„åŒ–æ–‡æ¡£æ—¶ä½¿ç”¨ `request.setIds(ids)`

------

## ğŸ“Š Mermaid æµç¨‹å›¾ï¼šæ··åˆæ£€ç´¢ä¸»æµç¨‹

```mermaid
 flowchart TD
 A[æ¥å£ filterList] --> B[searchDocuments]

    B --> C{æ˜¯å¦å¯å‘é‡æ£€ç´¢}
    C -- å…³é”®è¯ä¸ºç©º --> D[nonVectorSearch]
    C -- æœªä¸Šä¼ å‘é‡åº“ --> D

    C -- å¦ --> E[vectorSearch]
    E --> F[è·å– VectorStore KnowledgeBase]
    F --> G[æ„å»º Filter æ¡ä»¶]
    G --> H[æ‰§è¡Œ similaritySearch]

    H --> I{æ˜¯å¦å‘½ä¸­}
    I -- å¦ --> D[fallback: nonVectorSearch]
    I -- æ˜¯ --> J[æå– docIds]

    J --> K[ç”¨ docIds æŸ¥è¯¢ MySQL æ–‡æ¡£ä¿¡æ¯]
    K --> L[è¡¥å…¨æ ‡ç­¾ä¿¡æ¯]
    L --> M[æ„å»ºåˆ†é¡µç»“æœ PageResult]
    D --> N[è¿”å›ç»“æ„åŒ–ç»“æœ]
    M --> O[è¿”å›å‘é‡+ç»“æ„åŒ–æ··åˆç»“æœ]
```

------

## ğŸ§  æ€»ç»“ï¼šæ··åˆæ£€ç´¢çš„ä»·å€¼

| èƒ½åŠ›ç‚¹             | å®ç°æ–¹å¼                                      |
| ------------------ | --------------------------------------------- |
| ç”¨æˆ·å…³é”®è¯åŒ¹é…     | `vectorStore.similaritySearch()` â†’ è¯­ä¹‰ç†è§£   |
| ç²¾å‡†ç»“æ„åŒ–è¿‡æ»¤     | `Filter.ExpressionBuilder` â†’ æ ‡ç­¾ã€æ—¶é—´ã€ç´¢å¼• |
| ä¸å‘½ä¸­è‡ªåŠ¨é™çº§     | fallback åˆ° `nonVectorSearch()`               |
| ç»“æœè¡¥å…¨ï¼ˆå¦‚æ ‡ç­¾ï¼‰ | é€šè¿‡ `addTagsInfo()` è¡¥å…¨                     |
| æ”¯æŒåˆ†é¡µ / æ’åºç­‰  | ç»“åˆå‘é‡åº“ + MySQL æŸ¥è¯¢å¤„ç†                   |