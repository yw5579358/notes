# 模型切换变更

## 1.数据库表变更

```sql
ALTER TABLE t_model_config
ADD COLUMN model_parameters json NULL COMMENT '模型参数(JSON Map 序列化结果)';
```

- 模型配置表增加字段，可能不同模型参数不尽相同，使用json格式
- 该字段做为模型加载时默认配置，参考配置示例

```
{"topK": 30, "topP": 0.9, "temperature": 0.7}
```

## 2.接口变更

### 会话请求接口

![image-20250812174721781](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250812174721781.png)

- 新增参数 modelId  可指定不同模型
- 新增参数modelParams 可指定模型参数
- 默认两者均可不指定，modelParams仅在指定模型后生效

### 模型配置相关接口

![image-20250812175235291](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250812175235291.png)

- 模型配置接口已更新字段，更新配置后会清除缓存，再次使用该id会重新从库中加载

## 3流程逻辑

### 1. 模型初始化（启动时）

- 应用启动时，`ChatRelatedHelp`的`run()`方法触发：
  - 从数据库加载所有`chat`类型的模型配置列表；
  - 调用`ChatModelManager.initAllModels()`批量创建并缓存所有模型实例；
  - 读取平台设置中的默认模型ID，调用`initializeDefaultChatModel()`初始化默认聊天模型实例并缓存。

### 2. 获取聊天模型

- 调用`ChatRelatedHelp.getChatModel(Long id, String modelParams)`获取指定模型：
  - 若传入`id`为空，返回默认聊天模型；
  - 否则根据`id`查询模型配置，判断是否传入临时参数`modelParams`：
    - 若有临时参数，动态替换配置，创建临时模型实例，不缓存；
    - 否则调用`ChatModelManager.getOrCreateChatModel()`，缓存复用已有模型实例。

### 3. 创建聊天模型流程（`ChatModelManager.createChatModel()`）

- 校验`modelConfig`非空且类型为`chat`；
- 根据`modelConfig.getCategory()`选择具体模型构建方法：
  - `ollama`调用`createOllamaChatModel()`，解析参数，创建`OllamaChatModel`；
  - `openai`调用`createOpenAiChatModel()`，创建`OpenAiChatModel`；
  - `deepseek`调用`createDeepSeekChatModel()`，创建`DeepSeekChatModel`；
- 非临时模型会加入缓存，临时模型则不会缓存；
- 当前仅ollama模型使用模型参数，后续扩展其它模型需改动代码，但实现通用简单

### 4. 默认模型更新

- 调用`ChatRelatedHelp.updateDefaultChatModel(Long newChatModelId)`：
  - 获取新模型配置，清除旧模型缓存；
  - 创建新模型并缓存为默认模型；
  - 更新当前默认模型配置记录。

### 5. 模型配置变更处理

- `handleModelConfigUpdate(ModelConfig modelConfig)`：
  - 清除对应模型缓存；
  - 若更新的是当前默认模型，重新创建并缓存默认模型实例。
- `handleModelConfigDelete(Long modelId, String modelType)`：
  - 清除对应模型缓存；
  - 若删除的是当前默认模型，清空默认模型引用，需重新设置。

```mermaid
sequenceDiagram
    participant User as 用户/调用者
    participant Help as ChatRelatedHelp
    participant Config as ModelConfigService
    participant Manager as ChatModelManager

    User->>Help: getChatModel(id, modelParams)
    alt id == null
        Help-->>User: 返回 defaultChatModel
    else id != null
        Help->>Config: getById(id)
        Config-->>Help: modelConfig
        alt modelParams 有值
            Help->>Manager: getOrCreateChatModel(modelConfig, isTemp=true)
            Manager->>Manager: createChatModel(modelConfig, true)
            Manager-->>Help: 临时模型实例（不缓存）
            Help-->>User: 返回模型实例
        else modelParams 无
            Help->>Manager: getOrCreateChatModel(modelConfig, isTemp=false)
            alt 缓存存在
                Manager-->>Help: 缓存模型实例
                Help-->>User: 返回模型实例
            else 缓存不存在
                Manager->>Manager: createChatModel(modelConfig, false)
                Manager-->>Manager: 缓存模型实例
                Manager-->>Help: 模型实例
                Help-->>User: 返回模型实例
            end
        end
    end

```

```mermaid
flowchart TD
    A["应用启动"] --> B["加载所有 chat 模型配置"]
    B --> C["调用 ChatModelManager.initAllModels()"]
    C --> D["缓存所有模型实例"]
    D --> E["初始化默认聊天模型"]
```

```mermaid
flowchart TD  
  subgraph 获取聊天模型流程["获取聊天模型流程"]
    F["getChatModel(id, modelParams)"] --> G{"id 为空?"}
    G -- 是 --> H["返回默认模型"]
    G -- 否 --> I["查询 modelConfig"]
    I --> J{"是否有临时参数?"}
    J -- 是 --> K["创建临时模型（不缓存）"]
    J -- 否 --> L["调用 getOrCreateChatModel()"]
    L --> M{"缓存中存在?"}
    M -- 是 --> N["返回缓存模型"]
    M -- 否 --> O["创建新模型"]
    O --> P["缓存新模型"]
    P --> N
    N --> Q["返回模型实例"]
    H --> Q
    K --> Q
    end
```

```mermaid
flowchart TD  
  subgraph 默认模型更新流程["默认模型更新流程"]
    R["updateDefaultChatModel(newChatModelId)"] --> S["清除旧模型缓存"]
    S --> T["创建新模型并缓存"]
    T --> U["更新默认模型引用"]
    end
subgraph 模型配置更新处理["模型配置更新处理"]
    V["handleModelConfigUpdate(modelConfig)"] --> W["清除对应缓存"]
    W --> X{"是否为默认模型?"}
    X -- 是 --> Y["重新创建并缓存默认模型"]
    X -- 否 --> Z["结束"]
    Y --> Z
    end

    subgraph 模型配置删除处理["模型配置删除处理"]
    AA["handleModelConfigDelete(modelId, modelType)"] --> AB["清除对应缓存"]
    AB --> AC{"是否删除默认模型?"}
    AC -- 是 --> AD["清空默认模型引用"]
    AC -- 否 --> AE["结束"]
    AD --> AE
    end
```

